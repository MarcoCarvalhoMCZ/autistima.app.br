@model AUTistima.Models.Post
@{
    ViewData["Title"] = "Compartilhar Momento";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Cabe√ßalho acolhedor -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold">
                    <i class="bi bi-heart-fill text-salmon me-2"></i>
                    Compartilhe seu Momento
                </h1>
                <p class="lead text-secondary">
                    Este √© um espa√ßo seguro. Aqui voc√™ pode desabafar, pedir ajuda ou simplesmente 
                    compartilhar sua jornada. Voc√™ n√£o est√° sozinha. üíï
                </p>
            </div>

            <!-- Card do formul√°rio -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-salmon-light py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-heart me-2"></i>
                        Escreva sua mensagem
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label asp-for="Conteudo" class="form-label fw-semibold mb-0">
                                    <i class="bi bi-chat-heart me-1"></i>
                                    O que voc√™ gostaria de compartilhar?
                                </label>
                                <button type="button" id="btnGravarAudio" class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="toggleGravacao()">
                                    <i class="bi bi-mic-fill me-1"></i>
                                    <span id="txtBtnGravacao">Gravar Voz</span>
                                </button>
                                <button type="button" id="btnLerTexto" class="btn btn-sm btn-outline-secondary rounded-pill px-3 ms-2" onclick="toggleLeitura()">
                                    <i class="bi bi-volume-up-fill me-1"></i>
                                    <span id="txtBtnLeitura">Ouvir Texto</span>
                                </button>
                            </div>
                            <textarea asp-for="Conteudo" 
                                      class="form-control form-control-lg" 
                                      rows="6" 
                                      placeholder="Escreva aqui... Este √© um espa√ßo acolhedor onde outras m√£es v√£o te entender e apoiar."
                                      required></textarea>
                            <span asp-validation-for="Conteudo" class="text-danger"></span>
                            <div class="form-text">
                                <i class="bi bi-shield-check me-1"></i>
                                Sua mensagem ser√° compartilhada anonimamente se voc√™ preferir.
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="PermitirComentarios" class="form-check-input" type="checkbox" checked>
                                <label asp-for="PermitirComentarios" class="form-check-label">
                                    <i class="bi bi-chat-dots me-1"></i>
                                    Permitir que outras m√£es comentem e ofere√ßam apoio
                                </label>
                            </div>
                        </div>

                        <!-- Dica de acolhimento -->
                        <div class="alert alert-info border-0 mb-4">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-lightbulb fs-4"></i>
                                </div>
                                <div>
                                    <strong>Dica:</strong> Compartilhar nossas experi√™ncias ajuda outras m√£es 
                                    que podem estar passando pela mesma situa√ß√£o. Juntas somos mais fortes!
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-salmon btn-lg flex-grow-1">
                                <i class="bi bi-heart-fill me-2"></i>
                                Compartilhar com Amor
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left me-1"></i>
                                Voltar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Lembrete importante -->
            <div class="card mt-4 border-warning">
                <div class="card-body">
                    <h6 class="card-title text-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Precisa de ajuda urgente?
                    </h6>
                    <p class="card-text mb-2">
                        Se voc√™ est√° em uma situa√ß√£o de crise, entre em contato:
                    </p>
                    <ul class="mb-0">
                        <li><strong>CVV:</strong> Ligue 188 (24 horas)</li>
                        <li><strong>CAPS:</strong> Centro de Aten√ß√£o Psicossocial - Procure a unidade mais pr√≥xima</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let recognition = null;
        let isRecording = false;
        let synth = window.speechSynthesis;
        let isReading = false;

        function toggleLeitura() {
            if (!('speechSynthesis' in window)) {
                alert('Seu navegador n√£o suporta leitura de texto.');
                return;
            }

            const btn = document.getElementById('btnLerTexto');
            const txtBtn = document.getElementById('txtBtnLeitura');
            const icon = btn.querySelector('i');
            const textarea = document.getElementById('Conteudo');

            if (isReading) {
                // Parar leitura
                synth.cancel();
                isReading = false;
                
                // Restaurar bot√£o
                btn.classList.remove('btn-danger', 'text-white');
                btn.classList.add('btn-outline-secondary');
                icon.classList.remove('bi-stop-fill');
                icon.classList.add('bi-volume-up-fill');
                txtBtn.textContent = 'Ouvir Texto';
            } else {
                // Iniciar leitura
                const texto = textarea.value;
                if (!texto) {
                    alert('Escreva algo para ouvir.');
                    return;
                }

                // Configurar fala
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = 'pt-BR';
                
                // Tenta encontrar a melhor voz poss√≠vel (menos rob√≥tica)
                // Prioriza vozes "Google" (Chrome) ou "Microsoft" (Edge) que costumam ser neurais/naturais
                const voices = synth.getVoices();
                
                // Filtra apenas vozes em portugu√™s do Brasil
                const ptVoices = voices.filter(v => v.lang.replace('_', '-') === 'pt-BR');
                
                let bestVoice = null;

                if (ptVoices.length > 0) {
                    // 1. Tenta voz do Google (Geralmente a mais natural no Chrome/Android)
                    bestVoice = ptVoices.find(v => v.name.includes('Google'));
                    
                    // 2. Se n√£o, tenta vozes da Microsoft (Edge) ou Apple (Safari)
                    if (!bestVoice) {
                        bestVoice = ptVoices.find(v => v.name.includes('Microsoft') || v.name.includes('Luciana') || v.name.includes('Joana'));
                    }
                    
                    // 3. Fallback para qualquer voz pt-BR encontrada
                    if (!bestVoice) {
                        bestVoice = ptVoices[0];
                    }
                }

                if (bestVoice) {
                    utterance.voice = bestVoice;
                     // Ajustes finos para naturalidade
                    utterance.rate = 0.95; // Levemente mais lento ajuda na clareza
                    utterance.pitch = 1.0;
                }

                utterance.onend = () => {
                    // Quando terminar naturalmenente
                    isReading = true; // garante estado para chamar o toggle e resetar
                    toggleLeitura(); 
                };

                utterance.onerror = (e) => {
                    console.error('Erro na fala:', e);
                    isReading = true;
                    toggleLeitura();
                };

                synth.speak(utterance);
                isReading = true;

                // Atualizar bot√£o
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-danger', 'text-white');
                icon.classList.remove('bi-volume-up-fill');
                icon.classList.add('bi-stop-fill');
                txtBtn.textContent = 'Parar';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.continuous = true;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const textarea = document.getElementById('Conteudo');
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            const text = event.results[i][0].transcript.trim();
                            // Adiciona espa√ßo se j√° houver texto
                            if (textarea.value.length > 0 && !textarea.value.endsWith(' ')) {
                                textarea.value += ' ';
                            }
                            // Capitaliza a primeira letra do novo trecho
                            const formattedText = text.charAt(0).toUpperCase() + text.slice(1);
                            textarea.value += formattedText;
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Erro no reconhecimento:', event.error);
                    stopRecording();
                    if (event.error === 'not-allowed') {
                        alert('Precisamos de permiss√£o para usar o microfone.');
                    }
                };
                
                recognition.onend = () => {
                    if (isRecording) {
                        stopRecording();
                    }
                };

            } else {
                const btn = document.getElementById('btnGravarAudio');
                if(btn) btn.style.display = 'none';
            }
        });

        function toggleGravacao() {
            if (!recognition) return;

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            try {
                recognition.start();
                isRecording = true;
                const btn = document.getElementById('btnGravarAudio');
                const txt = document.getElementById('txtBtnGravacao');
                
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-danger', 'pulse-animation');
                btn.innerHTML = '<i class="bi bi-stop-circle-fill me-1"></i> Parar';
                
                // Feedback visual
                document.getElementById('Conteudo').placeholder = "Ouvindo... Pode falar...";
            } catch (e) {
                console.error(e);
            }
        }

        function stopRecording() {
            if(recognition) recognition.stop();
            isRecording = false;
            const btn = document.getElementById('btnGravarAudio');
            
            btn.classList.remove('btn-danger', 'pulse-animation');
            btn.classList.add('btn-outline-primary');
            btn.innerHTML = '<i class="bi bi-mic-fill me-1"></i> Gravar Voz';
            
            document.getElementById('Conteudo').placeholder = "Escreva aqui... Este √© um espa√ßo acolhedor onde outras m√£es v√£o te entender e apoiar.";
        }
    </script>
    <style>
        .pulse-animation {
            animation: pulse-red 1.5s infinite;
        }
        @@keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
}
